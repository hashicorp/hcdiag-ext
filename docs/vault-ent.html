<!DOCTYPE html>
<html>

<head>
  <title>hcdiag-ext for Vault Enterprise</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins|Inter|Roboto+Mono&display=swap" />
  <style>
    body {
      font-family: "Inter", sans-serif;
      font-size: 1em;
    }

    h1 {
      font-family: "Poppins", sans-serif;
    }

    pre {
      white-space: pre-wrap;
    }

    pre,
    code {
      margin: 0;
      padding: 0;
      padding-left: 1em;
    }

    button {
      padding: 12px 24px;
      font-size: 1em;
      border: none;
      border-radius: 0.2em;
      cursor: pointer;
      margin-top: 1em;
      color: #000000;
      background-color: #FFEC6E;
    }

    .code-block {
      background-color: #f6f8fa;
      border: 1px solid #d1d5da;
      border-radius: 0.2em;
      font-size: 0.75em;
    }

    code {
      font-family: "Roboto Mono", monospace;
    }
  </style>
  <script>
    var default_start_time = new Date();
    default_start_time.setMonth(default_start_time.getMonth() - 12);
    var default_start_time = default_start_time.toISOString();
    var default_end_time = new Date().toISOString();
    var queryString = window.location.search;
    var urlParams = new URLSearchParams(queryString);
    const start_time = urlParams.get("start_time") || default_start_time;
    const end_time = urlParams.get("end_time") || default_end_time;
    var times = "start_time=" + start_time + "&end_time=" + end_time;
  </script>
</head>

<body>
  <h1>hcdiag-ext for Vault Enterprise</h1>
  <p>For more information about how this configuration works, <a href="https://github.com/hashicorp/hcdiag-ext">see the
      README</a>.</p>
  <div class="code-block">
    <pre>
<code>
# Copyright (c) HashiCorp, Inc.
# SPDX-License-Identifier: MPL-2.0

# Vault Enterprise checks
  
host {
  selects = [":"] # noop to ensure no other default hcdiag host commands are auto-loaded
  shell {
    run = ":"
  }
}

product "vault" {
  selects = [
              "GET /v1/sys/health",
              "GET /v1/sys/internal/counters/activity?<script>document.write(times);</script>",
              "GET /v1/sys/storage/raft/autopilot/configuration",
              "GET /v1/sys/storage/raft/autopilot/state",
              "GET /v1/sys/storage/raft/snapshot-auto/config?list=true"
            ]

# check health endpoint for version, license.expiry_time, replication_dr_mode
  GET {
    path = "/v1/sys/health"
  }

# check vault usage on vault 1.6+
  GET {
    path = "/v1/sys/internal/counters/activity?<script>document.write(times);</script>"
  }

# check storage autopilot redundancy zones and automated upgrades
  GET {
    path = "/v1/sys/storage/raft/autopilot/configuration"
  }
  GET {
    path = "/v1/sys/storage/raft/autopilot/state"
  }

# check if snapshots are configured
  GET {
    path = "/v1/sys/storage/raft/snapshot-auto/config?list=true"
  }
}
</code>
    </pre>
  </div>
  <button onclick="downloadCode()">Download hcdiag-ext configuration file</button> or
  <button onclick="copyCode()">Copy to clipboard</button>
  <script>
    function downloadCode() {
      const code = document.querySelector(".code-block code").innerText;
      const blob = new Blob([code], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");

      link.setAttribute("href", url);
      link.setAttribute("download", "hcdiag_vault.hcl");
      link.style.display = "none";

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
    function copyCode() {
      const code = document.querySelector(".code-block code").innerText;
      navigator.clipboard.writeText(code)
        .then(() => {
          alert('Code copied to clipboard');
        })
        .catch((error) => {
          console.error('Failed to copy code:', error);
        });
    }
  </script>
</body>

</html>
