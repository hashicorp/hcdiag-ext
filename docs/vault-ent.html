<!DOCTYPE html>
<html>

<head>
  <title>hcdiag-ext for Vault Enterprise</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins|Inter|Roboto+Mono&display=swap" />
  <link rel="stylesheet" href="style.css" />
  <script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const startTimeParam = urlParams.get("start_time");
    const windowEnd = new Date();
    const windowStart = new Date();
    windowEnd.setDate(0); // set window end to the last day of the previous full month
    windowEnd.setHours(23, 59, 59, 999); // set window end to the last millisecond of the previous full month
    windowStart.setDate(1); // set window start to the first day of the current month
    windowStart.setHours(0, 0, 0, 0); // set window start to first millisecond of the day
    windowStart.setFullYear(windowStart.getFullYear() - 3); // set window start back three years
    const subStartDate = new Date(startTimeParam || new Date()); // sub start date is either query param start_time or current date
    subStartDate.setDate(1); // set sub start date to the first day of the month
    const subStartDateMinus5 = new Date(subStartDate.getFullYear() - 5, subStartDate.getMonth());
    const subStartDateMinus4 = new Date(subStartDate.getFullYear() - 4, subStartDate.getMonth());
    const subStartDateMinus3 = new Date(subStartDate.getFullYear() - 3, subStartDate.getMonth());
    const subStartDateMinus2 = new Date(subStartDate.getFullYear() - 2, subStartDate.getMonth());
    const subStartDateMinus1 = new Date(subStartDate.getFullYear() - 1, subStartDate.getMonth());
    const subStartDatePlus1 = new Date(subStartDate.getFullYear() + 1, subStartDate.getMonth());
    const subStartDatePlus2 = new Date(subStartDate.getFullYear() + 2, subStartDate.getMonth());
    const subStartDatePlus3 = new Date(subStartDate.getFullYear() + 3, subStartDate.getMonth());
    const subStartDatePlus4 = new Date(subStartDate.getFullYear() + 4, subStartDate.getMonth());
    const subStartDatePlus5 = new Date(subStartDate.getFullYear() + 5, subStartDate.getMonth());
    const allDates = [subStartDateMinus5, subStartDateMinus4, subStartDateMinus3, subStartDateMinus2, subStartDateMinus1, subStartDate, subStartDatePlus1, subStartDatePlus2, subStartDatePlus3, subStartDatePlus4, subStartDatePlus5];
    const filteredDates = allDates.filter(date => date >= subStartDate && date <= windowEnd);
    const timeQuerySelects = [];
    for (const sDate of filteredDates) {
      const sDatePlus1 = new Date(sDate.getFullYear() + 1, sDate.getMonth(), sDate.getDate());
      const eDate = sDatePlus1 > windowEnd ? windowEnd : sDatePlus1;
      const sDateISO = sDate.toISOString();
      const eDateISO = eDate.toISOString();
      const id = sDate.getFullYear();
      const timeQuery = `/v1/sys/internal/counters/activity?start_time=${sDateISO}&end_time=${eDateISO}&id=${id}`;
      timeQuerySelects.push(timeQuery);
    }
  </script>
</head>

<body>
  <h1>hcdiag-ext for Vault Enterprise</h1>
  <p id="warning">This page requires a <span class="code-block">start_time</span> querysting in YYYY-MM-DD format be
    included (eg <span class="code-block"><a href="?start_time=2021-07-15">?start_time=2021-07-15</a></span>) to
    generate the correct configuration. <em>If no querystring is present the configuration is incorrect.</em></p>
  <p>For more information about how this configuration works, <a href="https://github.com/hashicorp/hcdiag-ext">see the
      README</a>.</p>
  <div class="code-block">
    <pre>
<code>
# Copyright (c) HashiCorp, Inc.
# SPDX-License-Identifier: MPL-2.0

# Vault Enterprise checks
  
host {
  selects = [":"] # noop to ensure no other default hcdiag host commands are auto-loaded
  shell {
    run = ":"
  }
}

product "vault" {
  selects = [
              "GET /v1/sys/health",
<script>
  for (const i of timeQuerySelects) {
    document.write("              \"GET " + i + "\",<br>");
  }
</script>              "GET /v1/sys/storage/raft/autopilot/configuration",
              "GET /v1/sys/storage/raft/autopilot/state",
              "GET /v1/sys/storage/raft/snapshot-auto/config?list=true"
            ]

# check health endpoint for version, license.expiry_time, replication_dr_mode
  GET {
    path = "/v1/sys/health"
  }

# check vault usage on vault 1.6+
<script>
  for (const i of timeQuerySelects) {
    document.write("  GET {<br>");
    document.write("    path = \"" + i + "\",<br>");
    document.write("  }<br>");
  }</script>
# check storage autopilot redundancy zones and automated upgrades
  GET {
    path = "/v1/sys/storage/raft/autopilot/configuration"
  }
  GET {
    path = "/v1/sys/storage/raft/autopilot/state"
  }

# check if snapshots are configured
  GET {
    path = "/v1/sys/storage/raft/snapshot-auto/config?list=true"
  }
}
</code>
    </pre>
  </div>
  <button class="vault" onclick="downloadCode()">Download hcdiag-ext configuration file</button> or
  <button class="vault" onclick="copyCode()">Copy to clipboard</button>
  <script>
    if (startTimeParam && startTimeParam.length > 9) {
      const pWarning = document.getElementById('warning');
      pWarning.style.display = 'none';
    }
    function downloadCode() {
      const code = document.querySelector(".code-block code").innerText;
      const blob = new Blob([code], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "hcdiag_vault.hcl");
      link.style.display = "none";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
    function copyCode() {
      const code = document.querySelector(".code-block code").innerText;
      navigator.clipboard.writeText(code)
        .then(() => {
          alert('Code copied to clipboard');
        })
        .catch((error) => {
          console.error('Failed to copy code:', error);
        });
    }
  </script>
</body>

</html>
