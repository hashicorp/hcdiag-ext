<!DOCTYPE html>
<html>

<head>
  <title>hcdiag-ext for Vault Enterprise</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins|Inter|Roboto+Mono&display=swap" />
  <link rel="stylesheet" href="css/normalize.css" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="js/main.js"></script>
  <script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const startTimeParam = urlParams.get("start_time");
    const startTime = moment(startTimeParam).utc();
    const nowTime = moment().utc();
    const subWindowYears = nowTime.diff(startTime, 'years');
    const timeQuerySelects = [];
    for (let i = 0; i < subWindowYears; i++) {
      const startOfSubYear = startTime.clone()
        .startOf('month')
        .milliseconds(0)
      const endOfSubYear = startTime.clone()
        .add(1, 'year')
        .subtract(1, 'month')
        .endOf('month')
        .milliseconds(999)
      const startOfTimeWindow = startOfSubYear.add(i, 'years').format();
      const endOfTimeWindow = endOfSubYear.add(i, 'years').format();
      const yearQuery = `/v1/sys/internal/counters/activity?start_time=${startOfTimeWindow}&end_time=${endOfTimeWindow}`;
      timeQuerySelects.push(yearQuery);
    }
    const startOfFinalWindow = startTime.clone()
      .startOf('month')
      .milliseconds(0)
      .year(nowTime.get('year'))
      .format();
    const endOfFinalWindow = nowTime.clone()
      .subtract(1, 'month')
      .endOf('month')
      .milliseconds(999)
      .format();
    const finalQuery = `/v1/sys/internal/counters/activity?start_time=${startOfFinalWindow}&end_time=${endOfFinalWindow}`;
    timeQuerySelects.push(finalQuery);
    //console.log(timeQuerySelects);
  </script>
</head>

<body>
  <h1>hcdiag-ext for Vault Enterprise</h1>
  <h2>1. hcdiag-ext configuration</h2>
  <div id="warning">This page requires a valid <span class="code-block">start_time</span> querysting parameter in
    YYYY-MM-DD format be included (eg <span class="code-block"><a
        href="?start_time=2021-07-15">?start_time=2021-07-15</a></span>) to generate the correct configuration. <em>If
      no querystring is present the configuration is incorrect.</em>
  </div>
  <div id="configuration">
    <p>Download the hcl configuration using the download button, or if you want to paste the file contents directly into
      a file, copy the hcl file contents to your clipboard using the copy button.</p>
    <p>On your local machine or an instance in the product cluster, export the <span
        class="code-block">VAULT_TOKEN</span> and <span class="code-block">VAULT_ADDR</span> environment variables so
      hcdiag can query the product.</p>
    <p>When querying a Vault cluster remotely, the remote host currently needs the vault binary to pass an initial
      hcdiag startup check. We are looking to remove this requirement for all hcdiag-ext v0.5.x "API-only" use cases.
      The remote execution ability removes the need to install anything on the cluster, significantly easing use and
      reducing concerns around security and change management.</p>
    <p>An example Vault policy scoped for hcdiag-ext (<a href="hcdiag_vault_policy.hcl">hcdiag_vault_policy.hcl</a>) is
      contained in this release to limit the access hcdiag has within Vault.</p>
    <p>For more information about how this configuration works, <a href="https://github.com/hashicorp/hcdiag-ext">see
        the README</a>.</p>
    <div class="code-block">
      <pre>
<code>
# Copyright (c) HashiCorp, Inc.
# SPDX-License-Identifier: MPL-2.0

# Vault Enterprise checks
  
host {
  selects = [":"] # noop to ensure no other default hcdiag host commands are auto-loaded
  shell {
    run = ":"
  }
}

product "vault" {
  selects = [
              "GET /v1/sys/health",
<script>
  for (const i of timeQuerySelects) {
    document.write("              \"GET " + i + "\",<br>");
  }
</script>              "GET /v1/sys/storage/raft/autopilot/configuration",
              "GET /v1/sys/storage/raft/autopilot/state",
              "GET /v1/sys/storage/raft/snapshot-auto/config?list=true"
            ]

# check health endpoint for version, license.expiry_time, replication_dr_mode
  GET {
    path = "/v1/sys/health"
  }

# check vault usage on vault 1.6+
<script>
  for (const i of timeQuerySelects) {
    document.write("  GET {<br>");
    document.write("    path = \"" + i + "\",<br>");
    document.write("  }<br>");
  }</script>
# check storage autopilot redundancy zones and automated upgrades
  GET {
    path = "/v1/sys/storage/raft/autopilot/configuration"
  }
  GET {
    path = "/v1/sys/storage/raft/autopilot/state"
  }

# check if snapshots are configured
  GET {
    path = "/v1/sys/storage/raft/snapshot-auto/config?list=true"
  }
}</code>
      </pre>
    </div>
    <button id="downloadCode" class="vault" onclick="downloadCode('vault')">Download hcdiag-ext configuration file</button> or
    <button id="copyCode" class="vault" onclick="copyCode()">Copy configuration to clipboard</button>
  </div>
  <h2>2. hcdiag-ext results parser</h2>
  <p>Paste the contents of the results.json file from the hcdiag bundle into the below textarea and click the format
    button.</p>
  <div><textarea rows="10" placeholder="Paste the contents of the results.json file here..." id="jsonInput"></textarea>
  </div>
  <button class="vault" onclick="formatJSON()">Format results</button>
  <div id="errorOutput"></div>
  <div id="resultOutput">
    <table>
      <thead>
        <tr>
          <th style="width: 50%;">Check</th>
          <th style="width: 50%;">Result</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>Vault Enterprise Version</th>
          <td id="vaultEnterpriseVersionResult"></td>
        </tr>
        <tr>
          <th>Vault Enterprise License Expiry Date</th>
          <td id="licenseExpiryDateResultHuman"></td>
        </tr>
        <tr>
          <th>Vault Enterprise Consumption (clients)</th>
          <td id="vaultEnterpriseUsageClients"></td>
        </tr>
        <tr>
          <th>Disaster Recovery Replication Configured</th>
          <td id="disasterRecoveryReplicationConfigured"></td>
        </tr>
        <tr>
          <th>Named Snapshots Configured</th>
          <td id="namedSnapshotsConfigured"></td>
        </tr>
        <tr>
          <th>Redundancy Zones Configured</th>
          <td id="redundancyZonesConfigured"></td>
        </tr>
        <tr>
          <th>Storage Autopilot Upgrades Enabled</th>
          <td id="storageAutopilotUpgrades"></td>
        </tr>
      </tbody>
    </table>
  </div>
  <h2>3. Copy results for email</h2>
  <p>Once the table above is populated with parsed results, click the button to copy them to your clipboard to easily
    send them to your HashiCorp contact via email.</p>
  <button id="copyResult" class="vault" onclick="copyTable()">Copy table to clipboard</button>
  <script>
    const pWarning = document.getElementById('warning');
    const pConfiguration = document.getElementById('configuration');
    if (!validDate(startTimeParam)) {
      pWarning.style.display = 'block';
      pConfiguration.style.display = 'none';
    } else {
      pWarning.style.display = 'none';
      pConfiguration.style.display = 'block';
    }
    function formatJSON() {
      const jsonInput = document.getElementById("jsonInput").value;
      const errorOutput = document.getElementById("errorOutput");
      const resultOutput = document.getElementById("resultOutput");
      try {
        // Clear elements
        errorOutput.innerHTML = "";
        document.getElementById("vaultEnterpriseVersionResult").innerHTML = ""
        document.getElementById("licenseExpiryDateResultHuman").innerHTML = ""
        document.getElementById("vaultEnterpriseUsageClients").innerHTML = ""
        document.getElementById("disasterRecoveryReplicationConfigured").innerHTML = ""
        document.getElementById("namedSnapshotsConfigured").innerHTML = ""
        document.getElementById("redundancyZonesConfigured").innerHTML = ""
        document.getElementById("storageAutopilotUpgrades").innerHTML = ""
        // Parse JSON
        const data = JSON.parse(jsonInput);
        // Check some easy to read key paths
        const vaultEnterpriseVersionResult = String(deepGet(data, "vault.GET /v1/sys/health.result.response.version"));
        const licenseExpiryDateResult = String(deepGet(data, "vault.GET /v1/sys/health.result.response.license.expiry_time"));
        const disasterRecoveryReplicationConfiguration = String(deepGet(data, "vault.GET /v1/sys/health.result.response.replication_dr_mode"));
        const namedSnapshotsConfiguration = String(deepGet(data, "vault.GET /v1/sys/storage/raft/snapshot-auto/config?list=true.result.response.data.keys"));
        const redundancyZonesConfiguration = String(deepGet(data, "vault.GET /v1/sys/storage/raft/autopilot/state.result.response.data.redundancy_zones"));
        // Check the Vault Enterprise usage by finding the number of activity keys and looping through them :(
        const vaultEnterpriseUsageClients = formatUsage(data);
        // Convert the license expiry date to a human readable format
        const licenseExpiryDateResultHuman = (licenseExpiryDateResult === "Unknown") ? "Unknown" : new Date(licenseExpiryDateResult).toLocaleDateString('en-US', { day: '2-digit', month: 'long', year: 'numeric' });
        // Determine some Yes/No answers based on the results
        const storageAutopilotUpgrades = String(deepGet(data, "vault.GET /v1/sys/storage/raft/autopilot/configuration.result.response.data.disable_upgrade_migration")).replace("false", "Yes").replace("true", "No");
        const disasterRecoveryReplicationConfigured = (disasterRecoveryReplicationConfiguration === "disabled" || disasterRecoveryReplicationConfiguration === "unknown") ? "No" : "Yes";
        const namedSnapshotsConfigured = (namedSnapshotsConfiguration.length > 7) ? "Yes" : "No";
        const redundancyZonesConfigured = (redundancyZonesConfiguration.length > 7) ? "Yes" : "No";
        // Update the results table
        document.getElementById("vaultEnterpriseVersionResult").innerHTML = vaultEnterpriseVersionResult;
        document.getElementById("licenseExpiryDateResultHuman").innerHTML = licenseExpiryDateResultHuman;
        document.getElementById("vaultEnterpriseUsageClients").innerHTML = `${vaultEnterpriseUsageClients}`;
        document.getElementById("disasterRecoveryReplicationConfigured").innerHTML = `${disasterRecoveryReplicationConfigured} <span class="raw-result">${disasterRecoveryReplicationConfiguration}</span>`;
        document.getElementById("namedSnapshotsConfigured").innerHTML = `${namedSnapshotsConfigured} <span class="raw-result">${namedSnapshotsConfiguration}</span>`;
        document.getElementById("redundancyZonesConfigured").innerHTML = `${redundancyZonesConfigured} <span class="raw-result">${redundancyZonesConfiguration}</span>`;
        document.getElementById("storageAutopilotUpgrades").innerHTML = storageAutopilotUpgrades;
      } catch (error) {
        errorOutput.innerHTML = `<p id="warning">Invalid JSON: ${error.message}`;
      }
    }
  </script>
</body>

</html>
