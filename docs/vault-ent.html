<!DOCTYPE html>
<html>

<head>
  <title>hcdiag-ext for Vault Enterprise</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins|Inter|Roboto+Mono&display=swap" />
  <link rel="stylesheet" href="css/normalize.css" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="js/main.js"></script>
  <script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const startTimeParam = urlParams.get("start_time");
    const windowEnd = new Date();
    const windowStart = new Date();
    windowEnd.setDate(0); // set window end to the last day of the previous full month
    windowEnd.setHours(23, 59, 59, 999); // set window end to the last millisecond of the previous full month
    windowStart.setDate(1); // set window start to the first day of the current month
    windowStart.setHours(0, 0, 0, 0); // set window start to first millisecond of the day
    windowStart.setFullYear(windowStart.getFullYear() - 3); // set window start back three years
    const subStartDate = new Date(startTimeParam || new Date()); // sub start date is either query param start_time or current date
    subStartDate.setDate(1); // set sub start date to the first day of the month
    const subStartDateMinus5 = new Date(subStartDate.getFullYear() - 5, subStartDate.getMonth());
    const subStartDateMinus4 = new Date(subStartDate.getFullYear() - 4, subStartDate.getMonth());
    const subStartDateMinus3 = new Date(subStartDate.getFullYear() - 3, subStartDate.getMonth());
    const subStartDateMinus2 = new Date(subStartDate.getFullYear() - 2, subStartDate.getMonth());
    const subStartDateMinus1 = new Date(subStartDate.getFullYear() - 1, subStartDate.getMonth());
    const subStartDatePlus1 = new Date(subStartDate.getFullYear() + 1, subStartDate.getMonth());
    const subStartDatePlus2 = new Date(subStartDate.getFullYear() + 2, subStartDate.getMonth());
    const subStartDatePlus3 = new Date(subStartDate.getFullYear() + 3, subStartDate.getMonth());
    const subStartDatePlus4 = new Date(subStartDate.getFullYear() + 4, subStartDate.getMonth());
    const subStartDatePlus5 = new Date(subStartDate.getFullYear() + 5, subStartDate.getMonth());
    const allDates = [subStartDateMinus5, subStartDateMinus4, subStartDateMinus3, subStartDateMinus2, subStartDateMinus1, subStartDate, subStartDatePlus1, subStartDatePlus2, subStartDatePlus3, subStartDatePlus4, subStartDatePlus5];
    const filteredDates = allDates.filter(date => date >= subStartDate && date <= windowEnd);
    const timeQuerySelects = [];
    for (const sDate of filteredDates) {
      const sDatePlus1 = new Date(sDate.getFullYear() + 1, sDate.getMonth(), sDate.getDate());
      const eDate = sDatePlus1 > windowEnd ? windowEnd : sDatePlus1;
      const sDateISO = sDate.toISOString();
      const eDateISO = eDate.toISOString();
      const id = sDate.getFullYear();
      const timeQuery = `/v1/sys/internal/counters/activity?start_time=${sDateISO}&end_time=${eDateISO}&id=${id}`;
      timeQuerySelects.push(timeQuery);
    }
  </script>
</head>

<body>
  <h1>hcdiag-ext for Vault Enterprise</h1>
  <p id="warning">This page requires a <span class="code-block">start_time</span> querysting in YYYY-MM-DD format be
    included (eg <span class="code-block"><a href="?start_time=2021-07-15">?start_time=2021-07-15</a></span>) to
    generate the correct configuration. <em>If no querystring is present the configuration is incorrect.</em></p>
  <h2>1. hcdiag-ext configuration</h2>
  <p>Download the hcl configuration using the download button, or if you want to paste the file contents directly into a
    file, copy the hcl file contents to your clipboard using the copy button.</p>
  <p>On your local machine or an instance in the product cluster, export the <span class="code-block">VAULT_TOKEN</span>
    and <span class="code-block">VAULT_ADDR</span> environment variables so hcdiag can query the product.</p>
  <p>An example Vault policy scoped for hcdiag-ext (<a href="hcdiag_vault_policy.hcl">hcdiag_vault_policy.hcl</a>) is
    contained in this release to limit the access hcdiag has within Vault.</p>
  <p>For more information about how this configuration works, <a href="https://github.com/hashicorp/hcdiag-ext">see the
      README</a>.</p>

  <div class="code-block">
    <pre>
<code>
# Copyright (c) HashiCorp, Inc.
# SPDX-License-Identifier: MPL-2.0

# Vault Enterprise checks
  
host {
  selects = [":"] # noop to ensure no other default hcdiag host commands are auto-loaded
  shell {
    run = ":"
  }
}

product "vault" {
  selects = [
              "GET /v1/sys/health",
<script>
  for (const i of timeQuerySelects) {
    document.write("              \"GET " + i + "\",<br>");
  }
</script>              "GET /v1/sys/storage/raft/autopilot/configuration",
              "GET /v1/sys/storage/raft/autopilot/state",
              "GET /v1/sys/storage/raft/snapshot-auto/config?list=true"
            ]

# check health endpoint for version, license.expiry_time, replication_dr_mode
  GET {
    path = "/v1/sys/health"
  }

# check vault usage on vault 1.6+
<script>
  for (const i of timeQuerySelects) {
    document.write("  GET {<br>");
    document.write("    path = \"" + i + "\",<br>");
    document.write("  }<br>");
  }</script>
# check storage autopilot redundancy zones and automated upgrades
  GET {
    path = "/v1/sys/storage/raft/autopilot/configuration"
  }
  GET {
    path = "/v1/sys/storage/raft/autopilot/state"
  }

# check if snapshots are configured
  GET {
    path = "/v1/sys/storage/raft/snapshot-auto/config?list=true"
  }
}</code>
    </pre>
  </div>
  <button id="downloadCode" class="vault" onclick="downloadCode()">Download hcdiag-ext configuration file</button> or
  <button id="copyCode" class="vault" onclick="copyCode()">Copy configuration to clipboard</button>
  <h2>2. hcdiag-ext results parser</h2>
  <p>Paste the contents of the results.json file from the hcdiag bundle into the below textarea and click the format
    button.</p>
  <div><textarea rows="10" placeholder="Paste the contents of the results.json file here..." id="jsonInput"></textarea>
  </div>
  <button class="vault" onclick="formatJSON()">Format results</button>
  <div id="errorOutput"></div>
  <div id="resultOutput">
    <table>
      <thead>
        <tr>
          <th style="width: 50%;">Check</th>
          <th style="width: 50%;">Result</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>Vault Enterprise Version</th>
          <td id="vaultEnterpriseVersionResult"></td>
        </tr>
        <tr>
          <th>Vault Enterprise License Expiry Date</th>
          <td id="licenseExpiryDateResultHuman"></td>
        </tr>
        <tr>
          <th>Vault Enterprise Consumption (clients)</th>
          <td id="vaultEnterpriseUsageClients"></td>
        </tr>
        <tr>
          <th>Disaster Recovery Replication Configured</th>
          <td id="disasterRecoveryReplicationConfigured"></td>
        </tr>
        <tr>
          <th>Named Snapshots Configured</th>
          <td id="namedSnapshotsConfigured"></td>
        </tr>
        <tr>
          <th>Redundancy Zones Configured</th>
          <td id="redundancyZonesConfigured"></td>
        </tr>
        <tr>
          <th>Storage Autopilot Upgrades Enabled</th>
          <td id="storageAutopilotUpgrades"></td>
        </tr>
      </tbody>
    </table>
  </div>
  <h2>3. Copy results for email</h2>
  <p>Once the table above is populated with parsed results, click the button to copy them to your clipboard to easily
    send them to your HashiCorp contact via email.</p>
  <button id="copyResult" class="vault" onclick="copyTable()">Copy table to clipboard</button>
  <script>
    if (startTimeParam && startTimeParam.length > 9) {
      const pWarning = document.getElementById('warning');
      pWarning.style.display = 'none';
    }
    function formatJSON() {
      const jsonInput = document.getElementById("jsonInput").value;
      const resultOutput = document.getElementById("resultOutput");
      try {
        // Clear elements
        errorOutput.innerHTML = "";
        document.getElementById("vaultEnterpriseVersionResult").innerHTML = ""
        document.getElementById("licenseExpiryDateResultHuman").innerHTML = ""
        document.getElementById("vaultEnterpriseUsageClients").innerHTML = ""
        document.getElementById("disasterRecoveryReplicationConfigured").innerHTML = ""
        document.getElementById("namedSnapshotsConfigured").innerHTML = ""
        document.getElementById("redundancyZonesConfigured").innerHTML = ""
        document.getElementById("storageAutopilotUpgrades").innerHTML = ""
        const data = JSON.parse(jsonInput);
        const vaultEnterpriseVersionResult = String(deepGet(data, "vault.GET /v1/sys/health.result.response.version"));
        const licenseExpiryDateResult = String(deepGet(data, "vault.GET /v1/sys/health.result.response.license.expiry_time"));
        const vaultEnterpriseUsageClients = String(deepGet(data, "vault.GET /v1/sys/internal/counters/activity.result.response.data.total.clients"));
        const vaultEnterpriseUsageResults = String(deepGet(data, "vault.GET /v1/sys/internal/counters/activity.result.response.data.total"));
        const disasterRecoveryReplicationConfiguration = String(deepGet(data, "vault.GET /v1/sys/health.result.response.replication_dr_mode"));
        const namedSnapshotsConfiguration = String(deepGet(data, "vault.GET /v1/sys/storage/raft/snapshot-auto/config?list=true.result.response.data.keys"));
        const redundancyZonesConfiguration = String(deepGet(data, "vault.GET /v1/sys/storage/raft/autopilot/state.result.response.data.redundancy_zones"));
        const storageAutopilotUpgrades = String(deepGet(data, "vault.GET /v1/sys/storage/raft/autopilot/configuration.result.response.data.disable_upgrade_migration")).replace("false", "Yes").replace("true", "No");
        // Convert the license expiry date to a human readable format
        const licenseExpiryDateResultHuman = (licenseExpiryDateResult === "Unknown") ? "Unknown" : new Date(licenseExpiryDateResult).toLocaleDateString('en-US', { day: '2-digit', month: 'long', year: 'numeric' });
        // Determine some Yes/No answers based on the results
        const disasterRecoveryReplicationConfigured = (disasterRecoveryReplicationConfiguration === "disabled" || disasterRecoveryReplicationConfiguration === "unknown") ? "No" : "Yes";
        const namedSnapshotsConfigured = (namedSnapshotsConfiguration.length > 7) ? "Yes" : "No";
        const redundancyZonesConfigured = (redundancyZonesConfiguration.length > 7) ? "Yes" : "No";
        // Update the results table
        document.getElementById("vaultEnterpriseVersionResult").innerHTML = vaultEnterpriseVersionResult;
        document.getElementById("licenseExpiryDateResultHuman").innerHTML = licenseExpiryDateResultHuman;
        document.getElementById("vaultEnterpriseUsageClients").innerHTML = `${vaultEnterpriseUsageClients} <span class="raw-result">${vaultEnterpriseUsageResults}</span>`;
        document.getElementById("disasterRecoveryReplicationConfigured").innerHTML = `${disasterRecoveryReplicationConfigured} <span class="raw-result">${disasterRecoveryReplicationConfiguration}</span>`;
        document.getElementById("namedSnapshotsConfigured").innerHTML = `${namedSnapshotsConfigured} <span class="raw-result">${namedSnapshotsConfiguration}</span>`;
        document.getElementById("redundancyZonesConfigured").innerHTML = `${redundancyZonesConfigured} <span class="raw-result">${redundancyZonesConfiguration}</span>`;
        document.getElementById("storageAutopilotUpgrades").innerHTML = storageAutopilotUpgrades;
      } catch (error) {
        errorOutput.innerHTML = `<p id="warning">Invalid JSON: ${error.message}`;
      }
    }
  </script>
</body>

</html>
