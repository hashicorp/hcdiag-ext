<!DOCTYPE html>
<html>

<head>
  <title>hcdiag-ext for Terraform Enterprise</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins|Inter|Roboto+Mono&display=swap" />
  <link rel="stylesheet" href="css/normalize.css" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="js/main.js"></script>
</head>

<body>
  <h1>hcdiag-ext for Terraform Enterprise</h1>
  <h2>1. hcdiag-ext configuration</h2>
  <p>Download the hcl configuration using the download button, or if you want to paste the file contents directly into a
    file, copy the hcl file contents to your clipboard using the copy button.</p>
  <p>On your local machine or an instance in the product cluster, export the <span class="code-block">TFE_TOKEN</span>
    and <span class="code-block">TFE_HTTP_ADDR</span> environment variables so hcdiag can query the product.</p>
  <p>The token should be a user token for an account with administrator privileges so the admin API can be queried.</p>
  <p>For more information about how this configuration works, <a href="https://github.com/hashicorp/hcdiag-ext">see the
      README</a>.</p>
  <div class="code-block">
    <pre>
<code>
# Copyright (c) HashiCorp, Inc.
# SPDX-License-Identifier: MPL-2.0

# Terraform Enterprise checks

host {
  selects = [":"] # noop to ensure no other default hcdiag host commands are auto-loaded
  shell {
    run = ":"
  }
}

product "terraform-ent" {
  selects = [
              "GET /api/v2/admin/release",
              "GET /api/v2/admin/runs?page%5Bsize%5D=1",
              "GET /api/v2/admin/workspaces?page%5Bsize%5D=1",
            ]

# check version
  GET {
    path = "/api/v2/admin/release"
  }

# check enterprise features in use
  GET {
    path = "/api/v2/admin/runs?page%5Bsize%5D=1"
  }

# check workspace count
  GET {
    path = "/api/v2/admin/workspaces?page%5Bsize%5D=1" 
    }
  }</code>
    </pre>
  </div>
  <button id="downloadCode" class="terraform" onclick="downloadCode()">Download hcdiag-ext configuration file</button>
  or
  <button id="copyCode" class="terraform" onclick="copyCode()">Copy to clipboard</button>
  <h2>2. hcdiag-ext results parser</h2>
  <p>Paste the contents of the results.json file from the hcdiag bundle into the below textarea and click the format
    button.</p>
  <div><textarea rows="10" placeholder="Paste the contents of the results.json file here..." id="jsonInput"></textarea>
  </div>
  <button class="terraform" onclick="formatJSON()">Format results</button>
  <div id="errorOutput"></div>
  <div id="resultOutput">
    <table>
      <thead>
        <tr>
          <th style="width: 50%;">Check</th>
          <th style="width: 50%;">Result</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>Terraform Enterprise Version</th>
          <td id="tfeVersion"></td>
        </tr>
        <tr>
          <th>Terraform Enterprise License Expired</th>
          <td id="licenseExpiredResult"></td>
        </tr>
        <tr>
          <th>Terraform Enterprise Consumption (workspaces)</th>
          <td id="workspaceCountResult"></td>
        </tr>
        <tr>
          <th>Sentinel Policy Operations</th>
          <td id="sentinelChecksCompletedResult"></td>
        </tr>
        <tr>
          <th>Cost Estimation Calculations</th>
          <td id="costEstimationsCompletedResult"></td>
        </tr>
        <tr>
          <th>Run Task Operations</th>
          <td id="runTasksTotal"></td>
        </tr>
      </tbody>
    </table>
  </div>
  <h2>3. Copy results for email</h2>
  <p>Once the table above is populated with parsed results, click the button to copy them to your clipboard to easily
    send them to your HashiCorp contact via email.</p>
  <button id="copyResult" class="terraform" onclick="copyTable()">Copy table to clipboard</button>
  <script>
    function formatJSON() {
      const jsonInput = document.getElementById("jsonInput").value;
      const errorOutput = document.getElementById("errorOutput");
      try {
        // Clear elements
        errorOutput.innerHTML = "";
        document.getElementById("tfeVersion").innerHTML = "";
        document.getElementById("licenseExpiredResult").innerHTML = "";
        document.getElementById("workspaceCountResult").innerHTML = "";
        document.getElementById("sentinelChecksCompletedResult").innerHTML = "";
        document.getElementById("costEstimationsCompletedResult").innerHTML = "";
        document.getElementById("runTasksTotal").innerHTML = "";
        const data = JSON.parse(jsonInput);
        const tfeVersion = String(deepGet(data, "terraform-ent.GET /api/v2/admin/release.result.response.release"));
        const licenseExpiredResult = String(deepGet(data, "terraform-ent.replicatedctl license inspect.result.json[0].IsExpired")).replace("False", "No").replace("True", "Yes");
        const workspaceCountResult = String(deepGet(data, "terraform-ent.GET /api/v2/admin/workspaces?page%5Bsize%5D=1.result.response.meta.status-counts.total"));
        const sentinelChecksCompletedResult = String(deepGet(data, "terraform-ent.GET /api/v2/admin/runs?page%5Bsize%5D=1.result.response.meta.status-counts.policy-checked"));
        const costEstimationsCompletedResult = String(deepGet(data, "terraform-ent.GET /api/v2/admin/runs?page%5Bsize%5D=1.result.response.meta.status-counts.cost-estimated"));
        const runTasksPreApplyCompleted = deepGet(data, "terraform-ent.GET /api/v2/admin/runs?page%5Bsize%5D=1.result.response.meta.status-counts.pre-apply-completed");
        const runTasksPostPlanCompleted = deepGet(data, "terraform-ent.GET /api/v2/admin/runs?page%5Bsize%5D=1.result.response.meta.status-counts.post-plan-completed");
        // Sum the run tasks
        const runTasksTotal = runTasksPreApplyCompleted + runTasksPostPlanCompleted;
        // Update the results table
        document.getElementById("tfeVersion").innerHTML = tfeVersion;
        document.getElementById("licenseExpiredResult").innerHTML = licenseExpiredResult;
        document.getElementById("workspaceCountResult").innerHTML = workspaceCountResult;
        document.getElementById("sentinelChecksCompletedResult").innerHTML = sentinelChecksCompletedResult;
        document.getElementById("costEstimationsCompletedResult").innerHTML = costEstimationsCompletedResult;
        document.getElementById("runTasksTotal").innerHTML = runTasksTotal;
      } catch (error) {
        errorOutput.innerHTML = `<p id="warning">Invalid JSON: ${error.message}`;
      }
    }
  </script>
</body>

</html>
